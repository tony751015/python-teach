"use strict";(self["webpackChunkwound_chat"]=self["webpackChunkwound_chat"]||[]).push([[526],{2347:function(e,t,s){s.d(t,{A:function(){return p}});var a=s(1689),r=s(8834),i=s(4089),n=s(4852),o=function(){var e=this,t=e._self._c;return t(i.A,{attrs:{"hide-overlay":"",persistent:"",width:"300"},model:{value:e.dialog,callback:function(t){e.dialog=t},expression:"dialog"}},[t(a.A,{attrs:{color:"point-1",elevation:"1"}},[t(r.OQ,{staticClass:"loading-text"},[e._v(" "+e._s(e.showText)+" "),t(n.A,{staticClass:"mb-0",attrs:{indeterminate:"",color:"main-green"}})],1)],1)],1)},l=[],c={props:{showText:String,active:Boolean},data(){return{dialog:this.active}}},u=c,d=s(845),h=(0,d.A)(u,o,l,!1,null,"10136c39",null),p=h.exports},9526:function(e,t,s){s.r(t),s.d(t,{default:function(){return ae}});var a=s(8505),r=s(6929),i=s(8400),n=s(6074),o=s(375),l=s(1526),c=s(4739),u=s(9456),d=s(3825),h=s(2987),p=s(1075),g=s(9581),m=s(6520),f=s(1228),_=s(8412),v=s(7410),w=s(6648),y=s(5937),A=s(7043),b=function(){var e=this,t=e._self._c;return t(a.A,[t(r.A,{attrs:{color:"main-green",elevation:"0",dense:""}},[t(f.A,{staticClass:"d-sm-none"},[t(i.A)],1),t("img",{staticClass:"main-logo",attrs:{src:s(5332),alt:"logo"}}),t(v.A,[[t(w.A,{attrs:{"align-with-title":"","background-color":"transparent"}})]],2),t(m.A,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:s,attrs:a}){return[t(o.A,e._g(e._b({staticClass:"dropdown-btn",attrs:{rounded:"",color:"normal"}},"v-btn",a,!1),s),[t(n.A,{attrs:{size:"30"}},[t(d.A,{attrs:{src:e.thumb_avatar}})],1),t("span",{staticClass:"ml-2"},[e._v(e._s(e.username))]),t(u.A,{attrs:{right:""}},[e._v("mdi-chevron-down")])],1)]}}])},[t(h.A,{attrs:{dense:""}},[t(p.A,[t(g.UZ,{staticClass:"logoutBtn",on:{click:e.logout}},[e._v("log out")])],1)],1)],1)],1),t(c.A,{staticClass:"fill-height",attrs:{fluid:""}},[t(_.A,[t(l.A,{staticClass:"chat-section",attrs:{cols:"8"}},[t(A.A,{staticClass:"w-100",attrs:{flat:"",dense:""}},[t(y.A,{attrs:{"prepend-icon":"mdi-magnify",label:"Search for a chat",dense:"",outlined:"",color:"main-green",placeholder:"Search for a chat","hide-details":""},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.performSearch.apply(null,arguments)},input:e.onInput},model:{value:e.searchChat,callback:function(t){e.searchChat=t},expression:"searchChat"}}),e.searchResults.length>0||e.noResults?t(h.A,{staticClass:"search-results-list"},[e.searchResults.length>0?e._l(e.searchResults,(function(s,a){return t(p.A,{key:a,on:{click:function(t){return e.scrollToMessage(s.index)}}},[t(g.pr,[t(g.UZ,[e._v(e._s(s.content))])],1)],1)})):[t(p.A,[t(g.pr,[t(g.UZ,[e._v("No records found")])],1)],1)]],2):e._e()],1),t("chat-windows",{ref:"chatWindows",staticClass:"chatWindows"})],1),t("wound-photos",{attrs:{albums:e.albums,"current-album":e.currentAlbum,"selected-patient-id":e.userProfile.id},on:{"update:currentAlbum":function(t){e.currentAlbum=t},"update:current-album":[function(t){e.currentAlbum=t},e.updateCurrentAlbum]}})],1)],1)],1)},C=[],I=s(2781),P=s(4089),k=s(3224),x=function(){var e=this,t=e._self._c;return t(c.A,{staticClass:"chat-container"},[t(P.A,{attrs:{width:"200"},model:{value:e.detectError,callback:function(t){e.detectError=t},expression:"detectError"}},[t(I.A,{attrs:{dense:"",type:"error"}},[e._v(" Error ")])],1),t("div",{staticClass:"px-3"},[t("ProgressLoader",{key:e.activeKey,attrs:{showText:"LOADING...",active:e.activeProgress}}),t("div",{ref:"chatWindow",staticClass:"chat-window"},[t("infinite-loading",{attrs:{direction:"top",identifier:e.infiniteId},on:{infinite:e.infiniteHandler}},[t("div",{attrs:{slot:"no-more"},slot:"no-more"},[e._v("There are no more comments")]),t("div",{attrs:{slot:"no-results"},slot:"no-results"},[e._v("There are no more comments")])]),e._l(e.messages,(function(s,a){return t("chat-message",{key:a,attrs:{is_carer_user:s.is_carer_user,content_type:s.content_type,user_name:s.user_name,content:s.content,media_url:s.media_url,isFirstDate:s.isFirstDate},on:{"image-click":function(t){return e.openImagePopup(`${e.SERVER_PATH}media/${s.media_url}`)},"image-click2":function(t){return e.openImagePopup(s.media_url)}}})}))],2)],1),t("div",[t(k.A,{attrs:{row:""}},[t(y.A,{staticClass:"message-input mb-13 mx-3",attrs:{placeholder:"Type your message here",outlined:"",hint:"Shift + Enter for a new line, Enter to send: ","persistent-hint":"","append-icon":"mdi-emoticon-outline"},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage.apply(null,arguments)}},model:{value:e.newMessage,callback:function(t){e.newMessage=t},expression:"newMessage"}}),t(o.A,{staticClass:"send-btn px-1 mr-1",attrs:{elevation:"0",color:"white"},on:{click:e.sendMessage}},[t(u.A,{attrs:{color:"main-green"}},[e._v("mdi-send")])],1),t(o.A,{staticClass:"upload-btn main-green",attrs:{elevation:"0",color:"primary"},on:{click:e.openUploadImage}},[t(u.A,[e._v("mdi-paperclip")]),e._v(" Upload ")],1)],1)],1),t("ImagePopup",{key:`imgpop-${e.popImgKey}`,attrs:{image:e.selectedImage,visible:e.imagePopupVisible},on:{close:e.closeImagePopup}}),t("UploadImage",{key:`imgupload-${e.uploadImgKey}`,attrs:{activeUpload:e.uploadImage},on:{close:e.closeUploadImage,"update:visible":e.updateVisible,"message-uploaded":e.handleMessageUploaded}})],1)},S=[],U=(s(4114),s(4335)),T=s(1689),M=s(8834),R=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"date-divider text-center grey--text"},[e._v(e._s(e.isFirstDate))]),t(_.A,{class:e.alignmentClass,staticStyle:{margin:"0"}},["text"===e.content_type?t(l.A,{attrs:{cols:"auto"}},[t(T.A,{class:[e.messageClass,"mr-4"],attrs:{flat:""}},[t(M.OQ,{staticClass:"font-weight-bold",domProps:{innerHTML:e._s(e.contentRegexMatchURL)}})],1)],1):"image"===e.content_type?t(l.A,{key:e.media_url,staticClass:"img_col",attrs:{cols:"5"}},[t(T.A,{class:[e.messageClass,"mr-4"],attrs:{color:"point-1",flat:""}},[t("img",{attrs:{src:`${e.SERVER_PATH}media/${e.media_url}`},on:{click:function(t){return e.$emit("image-click",`${e.SERVER_PATH}media/${e.media_url}`)}}})])],1):"image2"===e.content_type?t(l.A,{key:e.media_url,staticClass:"img_col",attrs:{cols:"5"}},[t(T.A,{class:[e.messageClass,"mr-4"],attrs:{color:"point-1",flat:""}},[t("img",{attrs:{src:e.media_url},on:{click:function(t){return e.$emit("image-click2",e.media_url)}}})])],1):e._e()],1)],1)},$=[],E={name:"ChatMessage",props:{is_carer_user:{type:Boolean,required:!0},content_type:{type:String,required:!0},user_name:{type:String,required:!0},content:{type:String,required:!0},media_url:{type:String,required:!0},isFirstDate:{type:String,required:!0}},computed:{contentRegexMatchURL:function(){let e=this.content;const t=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)/g,s=e.match(t);return s&&(e=e.replace(t,`<a style="margin: 0 5px;" href="${s[0]}" target="_blank">${s[0]}</a>`)),e},alignmentClass(){const e=this.$root.userProfile?.super_user;return e?this.is_carer_user?"justify-end":"justify-start":this.is_carer_user?"justify-start":"justify-end"},messageClass(){const e=this.$root.userProfile?.super_user;return e?this.is_carer_user?"own-message":"other-message":this.is_carer_user?"other-message":"own-message"}},watch:{}},D=E,O=s(845),L=(0,O.A)(D,R,$,!1,null,"390f69ea",null),z=L.exports,F=s(2347),N=s(3209),j=s(2585),V=function(){var e=this,t=e._self._c;return t(P.A,{attrs:{"max-width":"500px",scrollable:""},model:{value:e.uploadImage,callback:function(t){e.uploadImage=t},expression:"uploadImage"}},[t(T.A,[t(M.ri,{staticClass:"font-large font-weight-bold text-center"},[e._v(" Please upload a photo of the wound "),t("span",{staticClass:"font-weight-regular font-small grey--text"},[e._v("Only accept JPG and PNG image files(Max: 8MB)")])]),t(M.OQ,[t(c.A,{staticClass:"uploader-area",class:{"is-dragging":e.fileOnDrag}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.filePreviewSrc,expression:"filePreviewSrc"}],staticClass:"uploader-preview"},[t(o.A,{staticClass:"uploader-remove-btn",on:{click:e.handleResetInput}},[t(u.A,{attrs:{color:"primary"}},[e._v("mdi-trash-can-outline")])],1),t(d.A,{attrs:{src:e.filePreviewSrc,contain:""}})],1),t("div",{directives:[{name:"show",rawName:"v-show",value:!e.filePreviewSrc,expression:"!filePreviewSrc"}]},[t("input",{ref:"fileInput",staticClass:"uploader-input",attrs:{type:"file",accept:"image/jpeg, image/png"},on:{dragenter:e.handleDragEnter,dragleave:e.handleDragEnter,dragdrop:e.handleDragDrop,change:e.handleInputChange}}),t("div",{staticClass:"uploader-interface"},[t(u.A,{attrs:{size:"40",color:"#dcdcdc"}},[e._v("mdi-cloud-upload-outline")]),t("p",{class:{"error-message":e.showErrorMsg}},[e._v(e._s(e.fileTips))]),t("p",{staticClass:"text-caption text-grey--text"},[e._v("Only accept JPG and PNG image files，Max: 8MB")])],1)])])],1),t(M.SL,{staticClass:"justify-end"},[t(o.A,{attrs:{text:"",color:"v-dark"},on:{click:e.handleClose}},[e._v("Cancel")]),t(o.A,{attrs:{color:"primary",text:"",disabled:!e.canUpload},on:{click:e.startUpload}},[e.showLoading?t(j.A,{attrs:{indeterminate:"",color:"white",size:"20"}}):t("span",[e._v("Submit upload")])],1)],1)],1)],1)},W=[],K=(s(4603),s(7566),s(8721),{props:{activeUpload:Boolean},data(){return{uploadImage:this.activeUpload,file:null,filePreviewSrc:"",fileOnDrag:!1,fileTips:"Drag and drop or click to upload images",showErrorMsg:!1,canUpload:!1,showLoading:!1}},methods:{startUpload(){let e;const t=JSON.parse(localStorage.getItem("mackay"));e=this.storeUserId?this.storeUserId:t.user_id;const s=!0===this.userProfile.super_user?"1":"0",a=new FormData,r=(new Date).getTime();console.log("this.file",this.file),a.append("user_id",e),a.append("is_carer_user",s),a.append("photo_upload",this.file,`${e}_${r}.${this.file.type.split("/")[1]}`),U.A.post("http://127.0.0.1:8000/api/chat/upload",a,{headers:{"Content-Type":"multipart/form-data"}}).then((e=>{console.log("Message sent successfully:",e.data),this.uploadImage=!1;const t=this.userProfile.name||"您",a={is_carer_user:"1"===s,user_name:t,media_url:this.filePreviewSrc,content_type:"image2",content:"",isFirstDate:""};this.$emit("message-uploaded",a),this.$root.$emit("upload-success")})).catch((e=>{console.error("Error sending message:",e)}))},triggerFileInput(){this.$refs.fileInput.click()},handleResetInput(){console.log("handleResetInput",this.$refs.fileInput),this.canUpload=!1,this.$refs.fileInput.value="",this.filePreviewSrc="",this.fileTips=this.$options.data().fileTips},handleInputChange(e){const t=e.target.files[0];t&&this.handleUploadFile(t)},handleUploadFile(e){if(this.fileOnDrag=!1,this.showErrorMsg=!1,"image/jpeg"===e.type||"image/png"===e.type){const t=window.URL||window.webkitURL,s=new Image;s.src=t.createObjectURL(e),s.onload=()=>{e.size<8192e3?(this.fileTips=e.name,this.canUpload=!0,this.filePreviewSrc=s.src,this.file=e):(this.showErrorMsg=!0,this.fileTips="File size must be under 8MB",this.file=null)}}else this.showErrorMsg=!0,this.fileTips="File format is not supported"},handleDragEnter(e){e.preventDefault(),this.fileOnDrag=!0},handleDragLeave(){this.fileOnDrag=!1},handleDragDrop(e){e.preventDefault(),this.fileOnDrag=!1;const t=e.dataTransfer.files;if(t&&t.length>0){const e=t[0];this.handleUploadFile(e)}},handleChange(e){this.handleUploadFile(e)},handleClose(){this.uploadImage=!1}}}),H=K,B=(0,O.A)(H,V,W,!1,null,"46cb4903",null),q=B.exports;const J="http://127.0.0.1:8000/api/chat/list?";var Z={name:"ChatWindows",components:{ImagePopup:N.A,ChatMessage:z,ProgressLoader:F.A,UploadImage:q},data(){return{newMessage:"",selectedImage:"",messages:[],user_name:"",user_id:null,preloader:!0,imagePopupVisible:!1,activeProgress:!1,detectError:!1,uploadImage:!1,page:1,popImgKey:1,uploadImgKey:1,activeKey:1,infiniteId:1}},created(){this.activeProgress=!0,this.$route.params.id?this.fetchMessages():this.routerRedirectTo404()},methods:{fetchMessages(){let e,t;const s=JSON.parse(localStorage.getItem("mackay"));t=this.userProfile.super_user?this.storeUserId:this.userProfile.id,e=t||s.user_id,console.log("fetchMessages",this.userProfile.id,this.storeUserId);const a=this.$route.params.id.split("-")[0];this.userProfile.super_user||e==a?(console.log("fetchMessages 1",e),U.A.get(J,{params:{user_id:e,page:this.page,size:3}}).then((e=>{e.data.count?this.user_name=e.data.results[0].user_name:this.user_name="",this.preloader=!1,this.messages=e.data.results.slice().reverse(),this.page+=1,this.infiniteId+=1,e.data.count?this.user_name=e.data.results[0].user_name:this.user_name="",setTimeout((()=>{this.$nextTick((()=>{this.activeProgress=!1,this.activeKey+=1;const e=this.$refs.chatWindow;e&&(e.scrollTop=e.scrollHeight)}))}),1e3)})).catch((e=>{this.detectError=!0,console.error(e)}))):this.routerRedirectTo404()},infiniteHandler(e){let t,s;const a=JSON.parse(localStorage.getItem("mackay"));s=this.userProfile.super_user?this.storeUserId:this.userProfile.id,t=s||a.user_id,this.preloader||U.A.get(J,{params:{user_id:t,page:this.page,size:3}}).then((t=>{t.data.results.length?(console.log("infiniteHandler",this.page),this.messages.unshift(...t.data.results.slice().reverse()),this.page+=1,e.loaded()):e.complete()}))},sendMessage(){let e,t;const s=JSON.parse(localStorage.getItem("mackay"));if(t=this.userProfile.super_user?this.storeUserId:this.userProfile.id,e=t||s.user_id,""!==this.newMessage.trim()){const t=this.userProfile.name||"您",s=!0===this.userProfile.super_user,a={is_carer_user:s,user_name:t,media_url:"",content:this.newMessage,content_type:"text",isFirstDate:""};this.messages.push(a),this.newMessage="",this.$nextTick((()=>{const e=this.$refs.chatWindow;e&&(e.scrollTop=e.scrollHeight)})),U.A.post("http://127.0.0.1:8000/api/chat/control",{user_id:e,is_carer_user:s,content:a.content,content_type:"text"}).then((e=>{console.log("Message sent successfully:",e.data)})).catch((e=>{console.error("Error sending message:",e)}))}},openImagePopup(e){this.selectedImage=e,this.imagePopupVisible=!0,this.popImgKey+=1,console.log("openImagePopup",this.imagePopupVisible)},closeImagePopup(e){this.imagePopupVisible=e,this.selectedImage="",this.popImgKey+=1},updateVisible(e){this.imagePopupVisible=e},openUploadImage(){this.uploadImage=!0,this.uploadImgKey+=1},closeUploadImage(){this.uploadImage=!1},handleMessageUploaded(e){console.log("Message uploaded:",e),this.messages.push(e)}}},G=Z,Q=(0,O.A)(G,x,S,!1,null,"a947bff6",null),X=Q.exports,Y=s(8694),ee={components:{ChatWindows:X,WoundPhotos:Y.A},data(){return{username:"使用者",thumb_avatar:"",searchChat:"",searchResults:[],noResults:!1,topBarNavList:["One","Two","Three"],chatRecord:[],albums:[],currentAlbum:0}},computed:{currentPhotos(){return this.albums[this.currentAlbum]?.photos||[]}},methods:{updateCurrentAlbum(e){this.currentAlbum=e},onInput(){this.performSearch()},performSearch(){const e=this.searchChat.trim().toLowerCase();if(e){const t=this.$refs.chatWindows.messages.map(((e,t)=>({content:e.content,index:t}))).filter((t=>t.content.toLowerCase().includes(e)));t.length>0?(this.searchResults=t,this.noResults=!1):(this.searchResults=[],this.noResults=!0)}else this.searchResults=[],this.noResults=!1},scrollToMessage(e){const t=this.$refs.chatWindows.$refs.chatWindow,s=t.children;if(s[e]){const a=s[e].offsetTop;t.scrollTo({top:a,behavior:"smooth"})}this.searchResults=[]}},mounted(){this.userProfile.name&&(this.username=this.userProfile.name),this.userProfile.thumb&&(this.thumb_avatar=this.userProfile.thumb)}},te=ee,se=(0,O.A)(te,b,C,!1,null,"75bca802",null),ae=se.exports},3224:function(e,t,s){s(158);var a=s(2186);t.A=(0,a.A)("layout")},6955:function(e,t,s){var a=s(2140),r=s(4901),i=s(4576),n=s(8227),o=n("toStringTag"),l=Object,c="Arguments"===i(function(){return arguments}()),u=function(e,t){try{return e[t]}catch(s){}};e.exports=a?i:function(e){var t,s,a;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(s=u(t=l(e),o))?s:c?i(t):"Object"===(a=i(t))&&r(t.callee)?"Arguments":a}},2106:function(e,t,s){var a=s(283),r=s(4913);e.exports=function(e,t,s){return s.get&&a(s.get,t,{getter:!0}),s.set&&a(s.set,t,{setter:!0}),r.f(e,t,s)}},2140:function(e,t,s){var a=s(8227),r=a("toStringTag"),i={};i[r]="z",e.exports="[object z]"===String(i)},655:function(e,t,s){var a=s(6955),r=String;e.exports=function(e){if("Symbol"===a(e))throw new TypeError("Cannot convert a Symbol value to a string");return r(e)}},2812:function(e){var t=TypeError;e.exports=function(e,s){if(e<s)throw new t("Not enough arguments");return e}},4603:function(e,t,s){var a=s(6840),r=s(9504),i=s(655),n=s(2812),o=URLSearchParams,l=o.prototype,c=r(l.append),u=r(l["delete"]),d=r(l.forEach),h=r([].push),p=new o("a=1&a=2&b=3");p["delete"]("a",1),p["delete"]("b",void 0),p+""!=="a=2"&&a(l,"delete",(function(e){var t=arguments.length,s=t<2?void 0:arguments[1];if(t&&void 0===s)return u(this,e);var a=[];d(this,(function(e,t){h(a,{key:t,value:e})})),n(t,1);var r,o=i(e),l=i(s),p=0,g=0,m=!1,f=a.length;while(p<f)r=a[p++],m||r.key===o?(m=!0,u(this,r.key)):g++;while(g<f)r=a[g++],r.key===o&&r.value===l||c(this,r.key,r.value)}),{enumerable:!0,unsafe:!0})},7566:function(e,t,s){var a=s(6840),r=s(9504),i=s(655),n=s(2812),o=URLSearchParams,l=o.prototype,c=r(l.getAll),u=r(l.has),d=new o("a=1");!d.has("a",2)&&d.has("a",void 0)||a(l,"has",(function(e){var t=arguments.length,s=t<2?void 0:arguments[1];if(t&&void 0===s)return u(this,e);var a=c(this,e);n(t,1);var r=i(s),o=0;while(o<a.length)if(a[o++]===r)return!0;return!1}),{enumerable:!0,unsafe:!0})},8721:function(e,t,s){var a=s(3724),r=s(9504),i=s(2106),n=URLSearchParams.prototype,o=r(n.forEach);a&&!("size"in n)&&i(n,"size",{get:function(){var e=0;return o(this,(function(){e++})),e},configurable:!0,enumerable:!0})}}]);
//# sourceMappingURL=526.9a561b09.js.map