{"version":3,"file":"css/939.2f0a1e27.css","mappings":"AACE,0BCEA,uEAEF,aACE,mBACA,aACA,WCL6B,CDM7B,kBACA,gBACA,sBAEA,oBACE,gBCZqB,CC+ezB,8BACA,0BACA,aACA,CACA,6CACA,WACA,CACA,oCACA,4BACA,YACA,eACA,CACA,gCACA,YACA,eACA,CACA,qCACA,WACA,aACA,6BACA,CACA,4BACA,YACA,cACA,CACA,+BACA,iBACA,CACA,qCACA,yBACA,iBACA,CACA,4BACA,eACA,iBACA,CACA,8BACA,gCACA,WACA,aACA,iBACA,CAEA,4BACA,WACA,WACA,CAEA,4BACA,kBACA,SACA,WACA,WACA,WACA,CAKA,qEACA,mBACA,CACA,8BACA,eACA,CACA,2BACA,0BACA,iBACA","sources":["webpack://wound-chat/./node_modules/vuetify/src/styles/tools/_theme.sass","webpack://wound-chat/./node_modules/vuetify/src/components/VSubheader/VSubheader.sass","webpack://wound-chat/./node_modules/vuetify/src/components/VSubheader/_variables.scss","webpack://wound-chat/./src/views/ChatList.vue"],"sourcesContent":["@mixin theme ($component)\n  .theme--light.#{$component}\n    @content($material-light)\n  .theme--dark.#{$component}\n    @content($material-dark)\n","@import './_variables.scss'\n\n+theme(v-subheader) using ($material)\n  color: map-deep-get($material, 'text', 'secondary')\n\n.v-subheader\n  align-items: center\n  display: flex\n  height: $subheader-item-single-height\n  font-size: map-deep-get($headings, 'body-2', 'size')\n  font-weight: map-deep-get($headings, 'body-2', 'weight')\n  padding: 0 $subheader-right-padding 0 $subheader-left-padding\n\n  &--inset\n    margin-left: $subheader-inset-margin\n","@import '../../styles/styles.sass';\n\n$subheader-inset-margin: 56px !default;\n$subheader-item-single-height: 48px !default;\n$subheader-left-padding: 16px !default;\n$subheader-right-padding: 16px !default;\n","<template>\r\n<div>\r\n  <!-- Topbar 區域 -->\r\n  <v-app-bar color=\"main-green\" elevation=\"0\" dense>\r\n    <v-responsive class=\"d-sm-none\">\r\n      <v-app-bar-nav-icon></v-app-bar-nav-icon>\r\n    </v-responsive>\r\n    \r\n    <img src=\"../assets/logo_dr.png\" class=\"main-logo\" alt=\"logo\">\r\n    <v-spacer>\r\n      <template>\r\n        <v-tabs align-with-title background-color=\"transparent\">\r\n        </v-tabs>\r\n      </template>\r\n    </v-spacer>\r\n    <v-menu offset-y>\r\n      <template v-slot:activator=\"{ on, attrs }\">\r\n        <v-btn class=\"dropdown-btn\" v-bind=\"attrs\" v-on=\"on\" rounded color=\"normal\">\r\n          <v-avatar size=\"30\">\r\n            <v-img :src=\"thumb_avatar\"></v-img>\r\n          </v-avatar>\r\n          <span class=\"ml-2\">{{ username }}</span>\r\n          <v-icon right>mdi-chevron-down</v-icon>\r\n        </v-btn>\r\n      </template>\r\n      <v-list dense>\r\n        <v-list-item>\r\n          <v-list-item-title class=\"logoutBtn\" @click=\"logout\">log out</v-list-item-title>\r\n        </v-list-item>\r\n      </v-list>\r\n    </v-menu>\r\n  </v-app-bar>\r\n  \r\n  <!-- 主要內容區塊 -->\r\n  <v-container fluid class=\"fill-height\">\r\n    <v-row>\r\n      <!-- 左側：用戶列表 -->\r\n      <v-col cols=\"8\" class=\"chat-list-section\">\r\n        <!-- 搜尋區域 -->\r\n        <v-text-field\r\n          v-model=\"searchQuery\"\r\n          prepend-icon=\"mdi-magnify\"\r\n          label=\"Search for a patient\"\r\n          dense\r\n          outlined\r\n          color=\"main-green\"\r\n          placeholder=\"Search for a patient\"\r\n          hide-details\r\n        ></v-text-field>\r\n        \r\n        <v-list>\r\n          <v-subheader>Patient census: {{ patientCount }}</v-subheader>\r\n            <template v-if=\"!preloading\">\r\n              <v-list-item\r\n                v-for=\"patient in visiblePatients\"\r\n                :key=\"patient.id\"\r\n                class=\"patient-item\"\r\n                @click=\"selectPatient(patient.user_id)\"\r\n                :class=\"{ 'outlined': highlightedPatientId === patient.user_id }\"\r\n              >\r\n                <v-list-item-avatar size=\"56\">\r\n                  <v-img :src=\"patient.user_avatar || require('@/assets/user.png')\"></v-img>\r\n                </v-list-item-avatar>\r\n            \r\n                <v-list-item-content>\r\n                  <v-list-item-title>\r\n                    {{ patient.user_name }}\r\n                    <span class=\"grey--text text--lighten-1 font-small\">{{ '(' + patient.user_id + ')'}}</span>\r\n                  </v-list-item-title>\r\n                  <v-list-item-subtitle>\r\n                    <span\r\n                      v-if=\"\r\n                        patient.last_message &&\r\n                        patient.last_message.content_type === 'text'\r\n                      \"\r\n                    >\r\n                      {{ patient.last_message.content }}\r\n                    </span>\r\n                    <span\r\n                      v-else-if=\"\r\n                        patient.last_message &&\r\n                        patient.last_message.content_type === 'image'\r\n                      \"\r\n                    >\r\n                      傳送了一張圖片\r\n                      <v-btn\r\n                        outlined\r\n                        color=\"main-green\"\r\n                        small\r\n                        class=\"px-1\"\r\n                        @click.stop=\"openImagePopup(\r\n                          `${SERVER_PATH}media/${patient.last_message.media_url}`\r\n                        )\"\r\n                      >\r\n                        <v-icon class=\"font-normal\">mdi-magnify</v-icon>\r\n                        photo\r\n                      </v-btn>\r\n                    </span>\r\n                    <span v-else>no message</span>\r\n                  </v-list-item-subtitle>\r\n                </v-list-item-content>\r\n                <v-list-item-action>\r\n                  <v-btn \r\n                    outlined\r\n                    elevation=\"0\"\r\n                    color=\"main-green\"\r\n                    small\r\n                    class=\"px-1\"\r\n                    @click.stop=\"goChatroom(patient)\"\r\n                  >Open Chat\r\n                    <!-- <v-icon>mdi-arrow-right-bold</v-icon> -->\r\n                  </v-btn>\r\n                </v-list-item-action>\r\n                <v-list-item-action>\r\n                  <v-btn \r\n                    fab \r\n                    elevation=\"0\"\r\n                    :color=\"patient.pin ? 'main-green' : ''\"\r\n                    @click.stop=\"togglePin(patient)\"\r\n                  >\r\n                    <v-icon :color=\"patient.pin ? 'white' : ''\">mdi-pin</v-icon>\r\n                  </v-btn>\r\n                </v-list-item-action>\r\n              </v-list-item>\r\n            \r\n              <infinite-loading \r\n                :identifier=\"infiniteId\"\r\n                @infinite=\"loadMorePatients\"\r\n                spinner=\"bubbles\"\r\n                direction=\"bottom\"\r\n              >\r\n                <div slot=\"no-more\" class=\"infini-note grey--text text--lighten-1 font-small\">No more data</div>\r\n                <div slot=\"no-results\" class=\"infini-note grey--text text--lighten-1 font-small\">No results found</div>\r\n              </infinite-loading>\r\n            </template>\r\n          \r\n        </v-list>\r\n      </v-col>\r\n\r\n      <!-- 右側：照片列表區域 -->\r\n      \r\n        <wound-photos\r\n          :albums=\"albums\"\r\n          :current-album.sync=\"currentAlbum\"\r\n          :selected-patient-id=\"selectedPatientId\"\r\n          @update:current-album=\"updateCurrentAlbum\"\r\n        ></wound-photos>\r\n      \r\n    </v-row>\r\n  </v-container>\r\n\r\n  <!-- 圖片彈出組件 -->\r\n  <ImagePopup\r\n    :key=\"`imgpop-${popImgKey}`\" \r\n    :visible=\"imageDialog\" \r\n    :image=\"imageSrc\" \r\n    @close=\"closeImagePopup\">\r\n  </ImagePopup>\r\n</div>\r\n</template>\r\n  \r\n<script>\r\n  import axios from 'axios';\r\n  import ImagePopup from '../components/ImagePopup.vue';\r\n  import WoundPhotos from '../components/WoundPhotos.vue';\r\n  import { mapMutations } from 'vuex';\r\n// import { reject, resolve } from 'core-js/fn/promise';\r\n  \r\n  export default {\r\n    components: {\r\n      ImagePopup,\r\n      WoundPhotos\r\n    },\r\n\r\n    created() {\r\n      this.initPatientsList();\r\n    },\r\n\r\n    data() {\r\n      return {\r\n        preloading: true,\r\n        username: '使用者',\r\n        thumb_avatar: '',\r\n        searchQuery: '',\r\n        imageDialog: false,\r\n        imageSrc: '',\r\n        popImgKey: 1,\r\n        patients: [],\r\n        patientCount: 0,\r\n        currentPage: 1,\r\n        pageSize: 1, // 每頁資料數量\r\n        infiniteId: +new Date(), // 確保重置 infinite-loading\r\n        pinnedPatients: [], // 存儲已經 pin 的病患 ID\r\n        selectedPatientId: -1, // 初始化為 -1\r\n        highlightedPatientId: null, // 用於追蹤當前選擇的病患\r\n        albums: [], // 初始化 albums 為空陣列\r\n        currentAlbum: 0, // 初始化 currentAlbum\r\n        dontRun: false\r\n      };\r\n    },\r\n    computed: {\r\n      filteredPatients() {\r\n        // 根據使用者輸入的搜尋字串過濾病患列表\r\n        // 如果病患的名字或 ID 包含搜尋字串，則保留該病患\r\n        return this.patients.filter(patient => \r\n            patient.user_name.includes(this.searchQuery) || \r\n            patient.user_id.toString().includes(this.searchQuery)\r\n        );\r\n      },\r\n      visiblePatients() {\r\n        return this.filteredPatients.filter(patient => !patient.is_superuser);\r\n      }\r\n    },\r\n    methods: {\r\n      openImagePopup(imageUrl) {\r\n        console.log('openImagePopup', imageUrl);\r\n        this.imageSrc = imageUrl;\r\n        this.imageDialog = true;\r\n        this.popImgKey += 1;\r\n      },\r\n      closeImagePopup() {\r\n        this.imageDialog = false;\r\n        this.imageSrc = '';\r\n        this.popImgKey += 1;\r\n      },\r\n      initPatientsList() {\r\n        axios.put('http://127.0.0.1:8000/api/chat/room', {\r\n          user_id: this.userProfile.id,\r\n          page: this.currentPage,\r\n          size: this.pageSize\r\n        })\r\n        .then(response => {\r\n          console.log(response.data.results);\r\n          if (response.data.results.length) {\r\n            this.patients.push(...response.data.results);\r\n            this.currentPage += 1;\r\n            this.preloading = false;\r\n            this.updatePatientCount(); // 更新 patientCount\r\n          } else {\r\n            this.preloading = true;\r\n          }\r\n        })\r\n        .catch(error => {\r\n          console.error(\"Error loading more patients:\", error);\r\n          this.updateAlert({\r\n            show: true,\r\n            status: 'error',\r\n            message: 'Opps! Something Wrong'\r\n          });\r\n          this.preloading = false;\r\n        });\r\n      },\r\n      loadMorePatients($state) {\r\n        if (!this.preloading) {\r\n          console.log(\"Loading more patients...\");\r\n          axios.put('http://127.0.0.1:8000/api/chat/room', {\r\n            user_id: this.userProfile.id,\r\n            page: this.currentPage,\r\n            size: this.pageSize\r\n          })\r\n          .then(response => {\r\n            console.log(response.data.results);\r\n            if (response.data.results.length) {\r\n              this.patients.push(...response.data.results);\r\n              this.currentPage += 1;\r\n              $state.loaded();\r\n              this.updatePatientCount(); // 更新 patientCount\r\n              // console.log(\"patients.\", JSON.stringify(this.patients));\r\n            } else {\r\n              $state.complete();\r\n              if (!this.dontRun) {\r\n                this.updateBanForSuperusers(); // 確保資料完整下載完後再執行\r\n                this.dontRun = true;\r\n              }\r\n            }\r\n          })\r\n          .catch(error => {\r\n            console.error(\"Error loading more patients:\", error);\r\n            this.updateAlert({\r\n              show: true,\r\n              status: 'error',\r\n              message: 'Opps! Something Wrong'\r\n            });\r\n            $state.complete();\r\n          });\r\n        }\r\n      },\r\n\r\n      togglePin(patient) {\r\n        const newPinState = !patient.pin;\r\n        patient.pin = newPinState;\r\n        axios.put('http://127.0.0.1:8000/api/chat/update_pin', {\r\n          user_id: this.userProfile.id,\r\n          pin: newPinState,\r\n          room_path: patient.room_path\r\n        })\r\n        .then(() => {\r\n          // if (newPinState) {\r\n          //   this.updateAlert({\r\n          //     show: true,\r\n          //     status: 'success',\r\n          //     message: 'Item pinned!'\r\n          //   });\r\n          // } else {\r\n          //   this.updateAlert({\r\n          //     show: true,\r\n          //     status: 'success',\r\n          //     message: 'Item unpinned!'\r\n          //   });\r\n          // }\r\n          this.startReloadPatientData();\r\n        })\r\n        .catch(error => {\r\n          console.error(\"Error updating pin state:\", error);\r\n        });\r\n      },\r\n\r\n      async startReloadPatientData() {\r\n        await this.reloadPatients();\r\n        await this.initPatientsList();\r\n      },\r\n\r\n      reloadPatients() {\r\n        // this.infiniteId += 1; // 重置 infinite-loading\r\n        return new Promise((resolve) => {\r\n          this.currentPage = 1;\r\n          this.patients = [];\r\n          this.preloading = true;\r\n          resolve();\r\n        })\r\n      },\r\n\r\n      selectPatient(userId) {\r\n        this.selectedPatientId = userId;\r\n        this.highlightedPatientId = userId;\r\n        // 確保 selectedPatientId 的變化能夠被 WoundPhotos.vue 監聽到\r\n      },\r\n      // reloadPatients() {\r\n      //   // this.infiniteId += 1; // 重置 infinite-loading\r\n      //   this.currentPage = 1;\r\n      //   this.patients = [];\r\n      //   this.preloading = true;\r\n      //   this.initPatientsList();\r\n\r\n      //   const process = new Promise((resolve, reject) => {\r\n      //     this.currentPage = 1;\r\n      //     this.patients = [];\r\n      //     this.preloading = true;\r\n\r\n      //     return resolve(this.preloading);\r\n      //   });\r\n\r\n      //   process.then((value) => {\r\n      //     if (value) {\r\n      //       this.initPatientsList();\r\n      //     }\r\n      //   });\r\n      // }\r\n      updateCurrentAlbum(newAlbumIndex) {\r\n        this.currentAlbum = newAlbumIndex;\r\n      },\r\n      goChatroom(patient) {\r\n        console.log('goChatroom', patient);\r\n        this.UPDATE_USER_ID(patient.user_id);\r\n\r\n        // 取得 localStorage 中的 mackay\r\n        const mackayData = JSON.parse(localStorage.getItem('mackay') || '{}');\r\n        \r\n        // 更新 user_id\r\n        mackayData.room_path = patient.room_path;\r\n        mackayData.selectedId = patient.user_id;\r\n        \r\n        // 將更新後的物件存回 localStorage\r\n        localStorage.setItem('mackay', JSON.stringify(mackayData));\r\n\r\n        this.$router.push({ path: `/chat/${patient.room_path}` });\r\n      },\r\n      updatePatientCount() {\r\n        this.patientCount = this.visiblePatients.length;\r\n      },\r\n      updateBanForSuperusers() {\r\n        const roomPathsToBan = this.patients\r\n          .filter(patient => patient.is_superuser)\r\n          .map(patient => patient.room_path);\r\n\r\n        if (roomPathsToBan.length > 0) {\r\n          axios.put('http://127.0.0.1:8000/api/chat/update_ban', {\r\n            user_id: this.userProfile.id,\r\n            ban: true,\r\n            room_paths: roomPathsToBan\r\n          })\r\n          .then(() => {\r\n            this.startReloadPatientData();\r\n          })\r\n          .catch(error => {\r\n            console.error(\"Error updating ban state:\", error);\r\n          });\r\n        }\r\n      },\r\n      ...mapMutations(['UPDATE_USER_ID'])\r\n    },\r\n    mounted() {\r\n      // const userId = this.userProfile.id;\r\n      // axios.put('http://127.0.0.1:8000/api/chat/room', {\r\n      //   user_id: userId,\r\n      //   page: \"1\",\r\n      //   size: \"5\"\r\n      // })\r\n      // .then(response => {\r\n      //   this.patients = response.data.results;\r\n      //   this.patientCount = response.data.count;\r\n      // })\r\n      // .catch(error => {\r\n      //   console.error('Error fetching data:', error);\r\n      // });\r\n  \r\n      if (this.userProfile.name) {\r\n        this.username = this.userProfile.name;\r\n      }\r\n      if (this.userProfile.thumb) {\r\n        this.thumb_avatar = this.userProfile.thumb;\r\n      }\r\n    }\r\n  };\r\n  </script>\r\n  \r\n  <style scoped>\r\n  .fill-height {\r\n    height: calc(100vh - 48px);\r\n    padding: unset;\r\n  }\r\n  .container.fill-height > .row{\r\n    height: 100%;\r\n  }\r\n  .chat-list-section {\r\n    border-right: 1px solid #ccc;\r\n    height: 100%;\r\n    overflow-y: auto;\r\n  }\r\n  .photo-section {\r\n    height: 100%;\r\n    overflow-y: auto;\r\n  }\r\n  .v-toolbar__content {\r\n    width: 100%;\r\n    display: flex;\r\n    justify-content: space-between;\r\n  }\r\n  .main-logo {\r\n    height: 100%;\r\n    padding: 10px 0px;\r\n  }\r\n  .patient-item{\r\n    margin-bottom: 2px;\r\n  }\r\n  .patient-item:hover {\r\n    background-color: #d4eaed;\r\n    border-radius: 5px;\r\n  }\r\n  .logoutBtn {\r\n    cursor: pointer;\r\n    text-align: center;\r\n  }\r\n  .image-popup {\r\n    background-color: rgba(0, 0, 0, 0.8); \r\n    width: calc(9/12 * 100vw); \r\n    height: 100vh;\r\n    position: relative;\r\n  }\r\n  \r\n  .popup-img {\r\n    width: 100%;\r\n    height: auto;\r\n  }\r\n  \r\n  .close-btn {\r\n    position: absolute;\r\n    top: 10px;\r\n    right: 10px;\r\n    color: white;\r\n    z-index: 101;\r\n  }\r\n  .v-btn:before {\r\n  opacity: 0 !important;\r\n}\r\n\r\n.v-ripple__container {\r\n  opacity: 0 !important;\r\n}\r\n.infini-note {\r\n  margin-top: 15px;          \r\n}   \r\n.outlined {\r\n  outline: 2px solid #2D9CA0;\r\n  border-radius: 5px;\r\n}\r\n  </style>"],"names":[],"sourceRoot":""}