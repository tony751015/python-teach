"use strict";(self["webpackChunkwound_chat"]=self["webpackChunkwound_chat"]||[]).push([[870],{8719:function(e,t,s){s.d(t,{A:function(){return p}});var a=s(5147),r=s(8560),i=s(5349),o=s(6582),n=function(){var e=this,t=e._self._c;return t(i.A,{attrs:{"hide-overlay":"",persistent:"",width:"300"},model:{value:e.dialog,callback:function(t){e.dialog=t},expression:"dialog"}},[t(a.A,{attrs:{color:"point-1",elevation:"1"}},[t(r.OQ,{staticClass:"loading-text"},[e._v(" "+e._s(e.showText)+" "),t(o.A,{staticClass:"mb-0",attrs:{indeterminate:"",color:"main-green"}})],1)],1)],1)},l=[],c={props:{showText:String,active:Boolean},data(){return{dialog:this.active}}},u=c,h=s(845),d=(0,h.A)(u,n,l,!1,null,"10136c39",null),p=d.exports},5870:function(e,t,s){s.r(t),s.d(t,{default:function(){return ae}});var a=s(9397),r=s(8920),i=s(9993),o=s(7061),n=s(8212),l=s(4528),c=s(8137),u=s(8528),h=s(9960),d=s(3711),p=s(9012),m=s(3462),g=s(7573),f=s(6299),_=s(1002),v=s(2492),A=s(9591),w=s(7667),y=s(3184),P=function(){var e=this,t=e._self._c;return t(a.A,[t(r.A,{attrs:{color:"main-green",elevation:"0",dense:""}},[t(f.A,{staticClass:"d-sm-none"},[t(i.A)],1),t("img",{staticClass:"main-logo",attrs:{src:s(5332),alt:"logo"}}),e.userProfile.super_user?t(n.A,{staticClass:"ml-6 white--text",attrs:{text:""},on:{click:function(t){return e.goChatList()}}},[e._v(" My Patients ")]):e._e(),t(v.A,[[t(A.A,{attrs:{"align-with-title":"","background-color":"transparent"}})]],2),t(g.A,{attrs:{"offset-y":""},scopedSlots:e._u([{key:"activator",fn:function({on:s,attrs:a}){return[t(n.A,e._g(e._b({staticClass:"dropdown-btn",attrs:{rounded:"",color:"normal"}},"v-btn",a,!1),s),[t(o.A,{attrs:{size:"30"}},[t(h.A,{attrs:{src:e.thumb_avatar}})],1),t("span",{staticClass:"ml-2"},[e._v(e._s(e.username))]),t(u.A,{attrs:{right:""}},[e._v("mdi-chevron-down")])],1)]}}])},[t(d.A,{attrs:{dense:""}},[t(p.A,[t(m.UZ,{staticClass:"logoutBtn",on:{click:e.logout}},[e._v("log out")])],1)],1)],1)],1),t(c.A,{staticClass:"fill-height",attrs:{fluid:""}},[t(_.A,[t(l.A,{staticClass:"chat-section",attrs:{cols:"8"}},[t(y.A,{staticClass:"w-100",attrs:{flat:"",dense:""}},[t(w.A,{attrs:{"prepend-icon":"mdi-magnify",label:"Search for a chat",dense:"",outlined:"",color:"main-green",placeholder:"Search for a chat","hide-details":""},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.performSearch.apply(null,arguments)},input:e.onInput},model:{value:e.searchChat,callback:function(t){e.searchChat=t},expression:"searchChat"}}),e.searchResults.length>0||e.noResults?t(d.A,{staticClass:"search-results-list"},[e.searchResults.length>0?e._l(e.searchResults,(function(s,a){return t(p.A,{key:a,on:{click:function(t){return e.scrollToMessage(s.index)}}},[t(m.pr,[t(m.UZ,[e._v(e._s(s.content))])],1)],1)})):[t(p.A,[t(m.pr,[t(m.UZ,[e._v("No records found")])],1)],1)]],2):e._e()],1),t("chat-windows",{ref:"chatWindows",staticClass:"chatWindows"})],1),t("wound-photos",{attrs:{albums:e.albums,"current-album":e.currentAlbum,"selected-patient-id":e.currentAlbum,selectedChatroom:e.selectedChatroom},on:{"update:currentAlbum":function(t){e.currentAlbum=t},"update:current-album":[function(t){e.currentAlbum=t},e.updateCurrentAlbum]}})],1)],1)],1)},C=[],I=(s(4114),s(6895)),b=s(5349),k=s(2482),x=function(){var e=this,t=e._self._c;return t(c.A,{staticClass:"chat-container"},[t(b.A,{attrs:{width:"200"},model:{value:e.detectError,callback:function(t){e.detectError=t},expression:"detectError"}},[t(I.A,{attrs:{dense:"",type:"error"}},[e._v(" Error ")])],1),t("div",{staticClass:"px-3"},[t("ProgressLoader",{key:e.activeKey,attrs:{showText:"LOADING...",active:e.activeProgress}}),t("div",{ref:"chatWindow",staticClass:"chat-window"},[t("infinite-loading",{attrs:{direction:"top",identifier:e.infiniteId},on:{infinite:e.infiniteHandler}},[t("div",{attrs:{slot:"no-more"},slot:"no-more"},[e._v("No more comments")]),t("div",{attrs:{slot:"no-results"},slot:"no-results"},[e._v("No more comments")])]),e._l(e.messages,(function(s,a){return t("chat-message",{key:a,attrs:{is_carer_user:s.is_carer_user,content_type:s.content_type,user_name:s.user_name,content:s.content,media_url:s.media_url,isFirstDate:s.isFirstDate},on:{"image-click":function(t){return e.openImagePopup(`${e.IMG_PATH}media/${s.media_url}`)},"image-click2":function(t){return e.openImagePopup(s.media_url)}}})}))],2)],1),t("div",[t(k.A,{staticClass:"send-message-layout",attrs:{row:""}},[t(w.A,{staticClass:"message-input mb-13 mx-3",attrs:{placeholder:"Type your message here",outlined:"",hint:"Shift + Enter for a new line, Enter to send: ","persistent-hint":""},on:{keyup:function(t){return!t.type.indexOf("key")&&e._k(t.keyCode,"enter",13,t.key,"Enter")?null:e.sendMessage.apply(null,arguments)}},model:{value:e.newMessage,callback:function(t){e.newMessage=t},expression:"newMessage"}}),t("button",{staticClass:"send-btn px-1 mr-1",attrs:{elevation:"0",color:"white"},on:{click:e.sendMessage}},[t(u.A,{attrs:{color:"main-green"}},[e._v("mdi-send")])],1),t(n.A,{staticClass:"upload-btn main-green",attrs:{elevation:"0",color:"primary"},on:{click:e.openUploadImage}},[t(u.A,[e._v("mdi-paperclip")]),e._v(" Upload ")],1)],1)],1),t("ImagePopup",{key:`imgpop-${e.popImgKey}`,attrs:{image:e.selectedImage,visible:e.imagePopupVisible},on:{close:e.closeImagePopup}}),t("UploadImage",{key:`imgupload-${e.uploadImgKey}`,attrs:{activeUpload:e.uploadImage},on:{close:e.closeUploadImage,"update:visible":e.updateVisible,"message-uploaded":e.handleMessageUploaded}})],1)},R=[],S=s(4335),$=s(5147),M=s(8560),T=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"date-divider text-center grey--text font-small"},[e._v(e._s(e.isFirstDate))]),t(_.A,{class:e.alignmentClass,staticStyle:{margin:"0"}},["text"===e.content_type?t(l.A,{attrs:{cols:"auto"}},[t($.A,{staticClass:"mr-4",class:[e.messageClass,"mr-4"],attrs:{flat:""}},[t(M.OQ,{staticClass:"font-large font-weight-bold font-weight-bold",domProps:{innerHTML:e._s(e.contentRegexMatchURL)}})],1)],1):"image"===e.content_type?t(l.A,{key:e.media_url,staticClass:"img_col img_col",attrs:{cols:"5"}},[t($.A,{staticClass:"mr-4",class:[e.messageClass,"mr-4"],attrs:{color:"point-1",flat:""}},[t("img",{attrs:{src:`${e.IMG_PATH}media/${e.media_url}`},on:{click:function(t){return e.$emit("image-click",`${e.IMG_PATH}media/${e.media_url}`)}}})])],1):"image2"===e.content_type?t(l.A,{key:e.media_url,staticClass:"img_col",attrs:{cols:"5"}},[t($.A,{staticClass:"mr-4",class:[e.messageClass,"mr-4"],attrs:{color:"point-1",flat:""}},[t("img",{attrs:{src:e.media_url},on:{click:function(t){return e.$emit("image-click2",e.media_url)}}})])],1):e._e()],1)],1)},U=[],E={name:"ChatMessage",props:{is_carer_user:{type:Boolean,required:!0},content_type:{type:String,required:!0},user_name:{type:String,required:!0},content:{type:String,required:!0},media_url:{type:String,required:!0},isFirstDate:{type:String,required:!0}},computed:{contentRegexMatchURL:function(){let e=this.content;const t=/https?:\/\/(?:www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b(?:[-a-zA-Z0-9()@:%_\+.~#?&\/=]*)/g,s=e.match(t);return s&&(e=e.replace(t,`<a style="margin: 0 5px;" href="${s[0]}" target="_blank">${s[0]}</a>`)),e},alignmentClass(){const e=this.$root.userProfile?.super_user;return e?this.is_carer_user?"justify-end":"justify-start":this.is_carer_user?"justify-start":"justify-end"},messageClass(){const e=this.$root.userProfile?.super_user;return e?this.is_carer_user?"own-message":"other-message":this.is_carer_user?"other-message":"own-message"}},watch:{}},D=E,O=s(845),L=(0,O.A)(D,T,U,!1,null,"1172d7bb",null),N=L.exports,z=s(8719),F=s(422),H=s(4923),V=function(){var e=this,t=e._self._c;return t(b.A,{attrs:{"max-width":"500px",scrollable:""},model:{value:e.uploadImage,callback:function(t){e.uploadImage=t},expression:"uploadImage"}},[t($.A,[t(M.ri,{staticClass:"font-large font-weight-bold text-center"},[e._v(" Please upload a photo of the wound "),t("span",{staticClass:"font-weight-regular font-small grey--text"},[e._v("Only accept JPG and PNG image files(Max: 8MB)")])]),t(M.OQ,[t(c.A,{staticClass:"uploader-area",class:{"is-dragging":e.fileOnDrag}},[t("div",{directives:[{name:"show",rawName:"v-show",value:e.filePreviewSrc,expression:"filePreviewSrc"}],staticClass:"uploader-preview"},[t(n.A,{staticClass:"uploader-remove-btn",on:{click:e.handleResetInput}},[t(u.A,{attrs:{color:"primary"}},[e._v("mdi-trash-can-outline")])],1),t(h.A,{attrs:{src:e.filePreviewSrc,contain:""}})],1),t("div",{directives:[{name:"show",rawName:"v-show",value:!e.filePreviewSrc,expression:"!filePreviewSrc"}]},[t("input",{ref:"fileInput",staticClass:"uploader-input",attrs:{type:"file",accept:"image/jpeg, image/png"},on:{dragenter:e.handleDragEnter,dragleave:e.handleDragEnter,dragdrop:e.handleDragDrop,change:e.handleInputChange}}),t("div",{staticClass:"uploader-interface"},[t(u.A,{attrs:{size:"40",color:"#dcdcdc"}},[e._v("mdi-cloud-upload-outline")]),t("p",{class:{"error-message":e.showErrorMsg}},[e._v(e._s(e.fileTips))]),t("p",{staticClass:"text-caption text-grey--text"},[e._v("Only accept JPG and PNG image files，Max: 8MB")])],1)])])],1),t(M.SL,{staticClass:"justify-end"},[t(n.A,{attrs:{text:"",color:"v-dark"},on:{click:e.handleClose}},[e._v("Cancel")]),t(n.A,{attrs:{color:"primary",text:"",disabled:!e.canUpload},on:{click:e.startUpload}},[e.showLoading?t(H.A,{attrs:{indeterminate:"",color:"white",size:"20"}}):t("span",[e._v("Submit upload")])],1)],1)],1)],1)},W=[],J=(s(4603),s(7566),s(8721),{props:{activeUpload:Boolean},data(){return{uploadImage:this.activeUpload,file:null,filePreviewSrc:"",fileOnDrag:!1,fileTips:"Drag and drop or click to upload images",showErrorMsg:!1,canUpload:!1,showLoading:!1}},methods:{startUpload(){const e=this.userProfile.id;let t;const s=JSON.parse(localStorage.getItem("mackay"));t=this.userProfile.super_user?s.room_path?s.room_path:this.storeChatRoom:this.userProfile.room_path;const a=!0===this.userProfile.super_user?"1":"0",r=new FormData,i=(new Date).getTime();console.log("this.file",this.file),r.append("user_id",e),r.append("chatRoom",t),r.append("is_carer_user",a),r.append("photo_upload",this.file,`${e}_${i}.${this.file.type.split("/")[1]}`),S.A.post(`${this.SERVER_PATH}api/chat/upload`,r,{headers:{"Content-Type":"multipart/form-data"}}).then((e=>{console.log("Message sent successfully:",e.data),this.uploadImage=!1;const t=this.userProfile.name||"您",s={is_carer_user:"1"===a,user_name:t,media_url:this.filePreviewSrc,content_type:"image2",content:"",isFirstDate:""};this.$emit("message-uploaded",s),this.$root.$emit("upload-success"),this.$nextTick((()=>{const e=this.$parent.$refs.chatWindow;e&&(e.scrollTop=e.scrollHeight)}))})).catch((e=>{console.error("Error sending message:",e)}))},triggerFileInput(){this.$refs.fileInput.click()},handleResetInput(){console.log("handleResetInput",this.$refs.fileInput),this.canUpload=!1,this.$refs.fileInput.value="",this.filePreviewSrc="",this.fileTips=this.$options.data().fileTips},handleInputChange(e){const t=e.target.files[0];t&&this.handleUploadFile(t)},handleUploadFile(e){if(this.fileOnDrag=!1,this.showErrorMsg=!1,"image/jpeg"===e.type||"image/png"===e.type){const t=window.URL||window.webkitURL,s=new Image;s.src=t.createObjectURL(e),s.onload=()=>{e.size<8192e3?(this.fileTips=e.name,this.canUpload=!0,this.filePreviewSrc=s.src,this.file=e):(this.showErrorMsg=!0,this.fileTips="File size must be under 8MB",this.file=null)}}else this.showErrorMsg=!0,this.fileTips="File format is not supported"},handleDragEnter(e){e.preventDefault(),this.fileOnDrag=!0},handleDragLeave(){this.fileOnDrag=!1},handleDragDrop(e){e.preventDefault(),this.fileOnDrag=!1;const t=e.dataTransfer.files;if(t&&t.length>0){const e=t[0];this.handleUploadFile(e)}},handleChange(e){this.handleUploadFile(e)},handleClose(){this.uploadImage=!1}}}),K=J,j=(0,O.A)(K,V,W,!1,null,"6871e6a3",null),B=j.exports,G={name:"ChatWindows",components:{ImagePopup:F.A,ChatMessage:N,ProgressLoader:z.A,UploadImage:B},data(){return{newMessage:"",selectedImage:"",messages:[],user_name:"",user_id:null,preloader:!0,imagePopupVisible:!1,activeProgress:!1,detectError:!1,uploadImage:!1,page:1,size:16,popImgKey:1,uploadImgKey:1,activeKey:1,infiniteId:1}},created(){this.activeProgress=!0,this.$route.params.id?this.fetchMessages():this.routerRedirectTo404()},methods:{fetchMessages(){let e,t,s;const a=JSON.parse(localStorage.getItem("mackay"));this.userProfile.super_user?(t=this.storeUserId,s=a.room_path?a.room_path:this.storeChatRoom):(t=this.userProfile.id,s=this.userProfile.room_path),e=t||a.selectedId,console.log("fetchMessages",this.userProfile.id,this.storeUserId);const r=this.$route.params.id.split("-")[0];if(this.userProfile.super_user){const e=JSON.parse(localStorage.getItem("mackay")),t=e.selectedId;if(t!=r)return void this.$router.push("/chat")}else if(e!=r)return void this.routerRedirectTo404();console.log("fetchMessages 1",e),S.A.get(`${this.SERVER_PATH}api/chat/list?`,{params:{user_id:this.userProfile.id,chatRoom:s,page:this.page,size:this.size}}).then((e=>{e.data.count?this.user_name=e.data.results[0].user_name:this.user_name="",console.log(JSON.stringify(e.data)),this.preloader=!1,this.messages=e.data.results,console.table("fetchMessages 3",this.messages),this.page+=1,this.infiniteId+=1,e.data.count?this.user_name=e.data.results[0].user_name:this.user_name="",setTimeout((()=>{this.$nextTick((()=>{this.activeProgress=!1,this.activeKey+=1;const e=this.$refs.chatWindow;e&&(e.scrollTop=e.scrollHeight)}))}),1e3)})).catch((e=>{this.detectError=!0,console.error(e.response.status),404===e.response.status||403===e.response.status?this.routerRedirectTo404():this.userProfile.super_user?this.$router.push({name:"chat-list"}):this.routerRedirectTo404()}))},infiniteHandler(e){let t;const s=JSON.parse(localStorage.getItem("mackay"));t=this.userProfile.super_user?s.room_path?s.room_path:this.storeChatRoom:this.userProfile.room_path,this.preloader||S.A.get(`${this.SERVER_PATH}api/chat/list?`,{params:{user_id:this.userProfile.id,chatRoom:t,page:this.page,size:this.size}}).then((t=>{!t.data.results.length||t.data.count<=this.size?e.complete():(console.log("infiniteHandler",this.page),this.messages.push(...t.data.results),this.page+=1,e.loaded())}))},sendMessage(){let e;const t=JSON.parse(localStorage.getItem("mackay"));if(e=this.userProfile.super_user?t.room_path?t.room_path:this.storeChatRoom:this.userProfile.room_path,""!==this.newMessage.trim()){const t=this.userProfile.name||"您",s=!0===this.userProfile.super_user,a={is_carer_user:s,user_name:t,media_url:"",content:this.newMessage,content_type:"text",isFirstDate:""};this.messages.push(a),this.newMessage="",this.$nextTick((()=>{const e=this.$refs.chatWindow;e&&(e.scrollTop=e.scrollHeight)})),S.A.post(`${this.SERVER_PATH}api/chat/control`,{user_id:this.userProfile.id,chatRoom:e,is_carer_user:s,content:a.content,content_type:"text"}).then((e=>{console.log("Message sent successfully:",e.data)})).catch((e=>{console.error("Error sending message:",e)}))}},openImagePopup(e){this.selectedImage=e,this.imagePopupVisible=!0,this.popImgKey+=1,console.log("openImagePopup",this.imagePopupVisible)},closeImagePopup(e){this.imagePopupVisible=e,this.selectedImage="",this.popImgKey+=1},updateVisible(e){this.imagePopupVisible=e},openUploadImage(){this.uploadImage=!0,this.uploadImgKey+=1},closeUploadImage(){this.uploadImage=!1},handleMessageUploaded(e){console.log("Message uploaded:",e),this.messages.push(e)}}},q=G,Z=(0,O.A)(q,x,R,!1,null,"44126ef8",null),Q=Z.exports,Y=s(3369),X=s(5353),ee={components:{ChatWindows:Q,WoundPhotos:Y.A},data(){return{username:"使用者",thumb_avatar:"",searchChat:"",searchResults:[],noResults:!1,topBarNavList:["One","Two","Three"],chatRecord:[],albums:[],currentAlbum:0,selectedChatroom:""}},computed:{currentPhotos(){return this.albums[this.currentAlbum]?.photos||[]}},methods:{updateCurrentAlbum(e){this.currentAlbum=e},onInput(){this.performSearch()},performSearch(){const e=this.searchChat.trim().toLowerCase();if(e){const t=this.$refs.chatWindows.messages.map(((e,t)=>({content:e.content,index:t}))).filter((t=>t.content.toLowerCase().includes(e)));t.length>0?(this.searchResults=t,this.noResults=!1):(this.searchResults=[],this.noResults=!0)}else this.searchResults=[],this.noResults=!1},scrollToMessage(e){const t=this.$refs.chatWindows.$refs.chatWindow,s=t.children;if(s[e]){const a=s[e].offsetTop;t.scrollTo({top:a,behavior:"smooth"})}this.searchResults=[]},goChatList(){this.UPDATE_USER_ID(this.userProfile.id);const e=JSON.parse(localStorage.getItem("mackay")||"{}");e.user_id=this.userProfile.id,localStorage.setItem("mackay",JSON.stringify(e)),this.$router.push({path:"/chat/"})},...(0,X.PY)(["UPDATE_USER_ID"])},mounted(){this.userProfile.name&&(this.username=this.userProfile.name),this.userProfile.thumb&&(this.thumb_avatar=this.userProfile.thumb)}},te=ee,se=(0,O.A)(te,P,C,!1,null,"6edac727",null),ae=se.exports},2482:function(e,t,s){s(1520);var a=s(3360);t.A=(0,a.A)("layout")}}]);
//# sourceMappingURL=870.fd2fbab1.js.map